# tag
# CC - Match 197 out of 626 with 0.3146964856230032
# > nummod - 0.8333333333333334 - 5/6
# CD - Match 41 out of 64 with 0.640625
# > dobj - 0.9090909090909091 - 10/11
# HYPH - Match 69 out of 103 with 0.6699029126213593
# > amod - 0.8928571428571429 - 25/28
# > compound - 0.8421052631578947 - 16/19
# > dobj - 1.0 - 4/4
# > nmod - 0.8181818181818182 - 9/11
# JJ - Match 698 out of 1155 with 0.6043290043290044
# > amod - 0.9523809523809523 - 20/21
# > compound - 0.8333333333333334 - 40/48
# > dobj - 0.8974358974358975 - 280/312
# > nmod - 1.0 - 10/10
# > poss - 0.8571428571428571 - 6/7
# NN - Match 2528 out of 4086 with 0.6186979931473323
# > acl - 0.8666666666666667 - 52/60
# > amod - 0.9230769230769231 - 24/26
# > compound - 0.8888888888888888 - 112/126
# > conj - 0.8086642599277978 - 224/277
# > dobj - 0.9254385964912281 - 422/456
# > nmod - 0.8214285714285714 - 23/28
# > pobj - 0.8077753779697624 - 374/463
# > xcomp - 0.8315789473684211 - 79/95
# NNP - Match 599 out of 1256 with 0.4769108280254777
# > dobj - 0.8641975308641975 - 70/81
# NNPS - Match 54 out of 61 with 0.8852459016393442
# > pcomp - 1.0 - 4/4
# NNS - Match 1229 out of 1670 with 0.7359281437125749
# > advcl - 0.8775510204081632 - 43/49
# > appos - 0.8181818181818182 - 9/11
# > compound - 0.9166666666666666 - 11/12
# > conj - 0.8366013071895425 - 128/153
# > dobj - 0.8314606741573034 - 74/89
# > pcomp - 0.9166666666666666 - 44/48
# > relcl - 0.8235294117647058 - 28/34
# > xcomp - 0.944 - 118/125
# PDT - Match 13 out of 19 with 0.6842105263157895
# > dobj - 0.8571428571428571 - 6/7
# PRP$ - Match 86 out of 103 with 0.8349514563106796
# > dobj - 0.9130434782608695 - 42/46
# > pobj - 0.8478260869565217 - 39/46
# SYM - Match 39 out of 62 with 0.6290322580645161
# > compound - 0.8461538461538461 - 11/13
# > dobj - 0.8888888888888888 - 8/9
# VBG - Match 72 out of 335 with 0.21492537313432836
# > nmod - 1.0 - 5/5
# VBN - Match 139 out of 530 with 0.2622641509433962
# > compound - 1.0 - 4/4

# tag.head
# CC - Match 273 out of 626 with 0.43610223642172524
# > dobj - 0.8181818181818182 - 63/77
# > nmod - 0.8181818181818182 - 27/33
# > nummod - 0.8333333333333334 - 5/6
# CD - Match 38 out of 64 with 0.59375
# > dobj - 0.9090909090909091 - 10/11
# HYPH - Match 70 out of 103 with 0.6796116504854369
# > amod - 0.8928571428571429 - 25/28
# > compound - 0.8421052631578947 - 16/19
# > dobj - 1.0 - 4/4
# > nmod - 0.8181818181818182 - 9/11
# > pobj - 0.8571428571428571 - 6/7
# JJ - Match 706 out of 1155 with 0.6112554112554113
# > amod - 0.9523809523809523 - 20/21
# > compound - 0.8333333333333334 - 40/48
# > dobj - 0.9294871794871795 - 290/312
# > nmod - 1.0 - 10/10
# > pobj - 0.8042813455657493 - 263/327
# > poss - 0.8571428571428571 - 6/7
# NN - Match 1473 out of 4086 with 0.3604992657856094
# > amod - 0.9615384615384616 - 25/26
# > compound - 0.9206349206349206 - 116/126
# > dobj - 0.9342105263157895 - 426/456
# > nsubjpass - 0.8181818181818182 - 36/44
# > pobj - 0.8099352051835853 - 375/463
# NNP - Match 501 out of 1256 with 0.39888535031847133
# > dobj - 0.8641975308641975 - 70/81
# NNS - Match 427 out of 1670 with 0.255688622754491
# > appos - 0.9090909090909091 - 10/11
# > compound - 1.0 - 12/12
# > dobj - 0.8314606741573034 - 74/89
# PDT - Match 14 out of 19 with 0.7368421052631579
# > dobj - 1.0 - 7/7
# PRP$ - Match 86 out of 103 with 0.8349514563106796
# > dobj - 0.9130434782608695 - 42/46
# > pobj - 0.8478260869565217 - 39/46
# SYM - Match 38 out of 62 with 0.6129032258064516
# > compound - 0.8461538461538461 - 11/13
# > dobj - 0.8888888888888888 - 8/9
# VBG - Match 106 out of 335 with 0.3164179104477612
# > dobj - 0.8222222222222222 - 37/45
# > nmod - 1.0 - 5/5
# VBN - Match 232 out of 530 with 0.4377358490566038
# > compound - 1.0 - 4/4
# > dobj - 0.8761904761904762 - 92/105
# > pobj - 0.8487394957983193 - 101/119
# VBP - Match 34 out of 143 with 0.23776223776223776
# > dobj - 1.0 - 13/13
# VBZ - Match 42 out of 367 with 0.11444141689373297
# > dobj - 0.8421052631578947 - 16/19


import logging

from spacy.tokens import Span

from src.utils.typing import RuleReturn

logger = logging.getLogger(__name__)

resource: str = "Resource"


def tag_label(tag: str, head_dep: str) -> str | None:
    for tag_ans, head_dep_lists in [
        ("CC", ["nummod"]),
        ("CD", ["dobj"]),
        ("HYPH", ["amod", "compound", "dobj", "nmod"]),
        ("JJ", ["amod", "compound", "dobj", "nmod", "poss"]),
        (
            "NN",
            [
                "acl",
                "amod",
                "compound",
                "conj",
                "dobj",
                "nmod",
                "pobj",
                "xcomp",
            ],
        ),
        ("NNP", ["dobj"]),
        ("NNPS", ["pcomp"]),
        (
            "NNS",
            [
                "advcl",
                "appos",
                "compound",
                "conj",
                "dobj",
                "pcomp",
                "relcl",
                "xcomp",
            ],
        ),
        ("PDT", ["dobj"]),
        ("PRP$", ["dobj", "pobj"]),
        ("SYM", ["compound", "dobj"]),
        ("VBG", ["nmod"]),
        ("VBN", ["compound"]),
    ]:
        if tag == tag_ans and head_dep in head_dep_lists:
            logger.debug(f"{tag}, {head_dep}")
            return resource

    return None


def tag_head_label(tag: str, head_dep: str) -> str | None:
    for tag_ans, head_dep_lists in [
        ("CC", ["nummod", "dobj", "nmod"]),
        ("CD", ["dobj"]),
        ("HYPH", ["amod", "compound", "dobj", "nmod", "pobj"]),
        ("JJ", ["amod", "compound", "dobj", "nmod", "poss", "pobj"]),
        ("NN", ["amod", "compound", "dobj", "nsubjpass", "pobj"]),
        ("NNP", ["dobj"]),
        ("NNPS", ["pcomp"]),
        ("NNS", ["appos", "compound", "dobj"]),
        ("PDT", ["dobj"]),
        ("PRP$", ["dobj", "pobj"]),
        ("SYM", ["compound", "dobj"]),
        ("VBG", ["nmod", "dobj"]),
        ("VBN", ["compound", "dobj", "pobj"]),
        ("VBP", ["dobj"]),
        ("VBZ", ["dobj"]),
    ]:
        if tag == tag_ans and head_dep in head_dep_lists:
            logger.debug(f"Head: {tag}, {head_dep}")
            return resource

    return None


def tag_base(s: Span) -> RuleReturn:
    result = list()

    for token in s:
        tag = token.tag_
        head_dep = token.head.dep_
        label = tag_label(tag, head_dep)
        if label:
            result.append((token, label))
        head_label = tag_head_label(tag, head_dep)
        if head_label:
            result.append((token.head, head_label))

    logger.debug(f"Length {len(result)}: {result}")

    return result
